
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø«Ø¨Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø§Ø±ÛŒ</title>
    
    <link rel="apple-touch-icon" href="https://en.iranalumina.ir/wp-content/uploads/2017/09/Site-Logo1.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Kama Datepicker CSS -->
	<link href="kamadatepicker.min.css" rel="stylesheet" />
    
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f3f4f6; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
            padding-left: 2.5rem; -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .hidden-view { display: none !important; }
        
        div[id^="bd-main-persian-date-picker-container"] { z-index: 9999 !important; }
        
        .editing-row { background-color: #eff6ff !important; border-left: 4px solid #2563eb; }
        
        @keyframes sparkle { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .sparkle-icon { animation: sparkle 2s infinite; display: inline-block; }
        
        @keyframes pulse-ring { 0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .mic-active { animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: #fee2e2 !important; color: #dc2626 !important; border-color: #dc2626 !important; }

        .prose h3 { font-weight: bold; color: #1e40af; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-right: 1.5em; margin-bottom: 1em; }
        .prose p { margin-bottom: 0.5em; line-height: 1.6; }
    </style>
    
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <script src="jquery-3.6.0.min.js"></script>
    <script src="kamadatepicker.min.js"></script>
    <script src="moment.min.js"></script>
    <script src="moment-timezone-with-data.min.js"></script>
    <script src="jalali-moment.browser.js"></script>
    <script src="xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-view" class="container mx-auto p-4 md:p-8 max-w-4xl hidden-view">
        <header class="text-center mb-8 flex flex-col items-center">
            <img src="logo.png" alt="Ù„ÙˆÚ¯Ùˆ" class="h-[42px] w-[42px] mb-4 object-contain" onerror="this.src='https://placehold.co/42x42/cccccc/ffffff?text=IAC'">
            <h1 class="text-2xl font-bold text-gray-800">Ø´Ø±Ú©Øª Ø¢Ù„ÙˆÙ…ÛŒÙ†Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†</h1>
            <p class="text-lg text-gray-600">Ø«Ø¨Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø§Ø±ÛŒ</p>
        </header>

        <main>
            <div class="mb-6">
                <button id="open-smart-fill" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:from-indigo-700 hover:to-purple-700 transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
                    <span class="text-xl sparkle-icon">âœ¨</span>
                    <span>ÙˆØ±ÙˆØ¯ Ù‡ÙˆØ´Ù…Ù†Ø¯ (ØµÙˆØªÛŒ / Ù…ØªÙ†ÛŒ)</span>
                </button>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8 border-t-4 border-blue-600 relative">
                 <div id="editing-badge" class="hidden absolute top-0 left-0 bg-yellow-400 text-yellow-900 text-xs px-3 py-1 rounded-br-lg font-bold">Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´...</div>
                 <form id="overtime-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
                    <div>
                        <label for="date-input" class="block mb-2 font-medium text-gray-700">ØªØ§Ø±ÛŒØ®</label>
                        <input type="text" id="date-input" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®" class="w-full p-3 border border-gray-300 rounded-lg text-center bg-white cursor-pointer focus:ring-2 focus:ring-blue-500 outline-none" readonly>
                        <p id="auto-shift-display" class="text-sm text-blue-600 mt-2 text-center font-semibold h-5 min-h-[1.25rem]"></p>
                    </div>
                    <div>
                        <label for="shift-type" class="block mb-2 font-medium text-gray-700">Ù†ÙˆØ¹ Ø§ÛŒÙ† Ø§Ø¶Ø§ÙÙ‡ Ú©Ø§Ø±</label>
                        <select id="shift-type" class="w-full p-3 border border-gray-300 rounded-lg form-select focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="morning">Ø´ÛŒÙØª ØµØ¨Ø­</option>
                            <option value="evening">Ø´ÛŒÙØª Ø¹ØµØ±</option>
                            <option value="night">Ø´ÛŒÙØª Ø´Ø¨</option>
                            <option value="change_shift">Ú†Ù†Ø¬ Ø´ÛŒÙØª</option>
                            <option value="rest">Ø§Ø³ØªØ±Ø§Ø­Øª</option>
                            <option value="holiday">Ø±ÙˆØ² ØªØ¹Ø·ÛŒÙ„</option>
                        </select>
                    </div>
                    <!-- Time Inputs Changed to Type Time -->
                    <div>
                        <label for="start-time" class="block mb-2 font-medium text-gray-700">Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹</label>
                        <input type="time" id="start-time" class="w-full p-3 border border-gray-300 rounded-lg text-center bg-white focus:ring-2 focus:ring-blue-500 outline-none dir-ltr">
                    </div>
                    <div>
                        <label for="end-time" class="block mb-2 font-medium text-gray-700">Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù†</label>
                        <input type="time" id="end-time" class="w-full p-3 border border-gray-300 rounded-lg text-center bg-white focus:ring-2 focus:ring-blue-500 outline-none dir-ltr">
                    </div>
                    <div class="md:col-span-2">
                        <label for="successor-input" class="block mb-2 font-medium text-gray-700">Ø¬Ø§Ù†Ø´ÛŒÙ† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                        <input type="text" id="successor-input" placeholder="Ù†Ø§Ù… Ù‡Ù…Ú©Ø§Ø± Ø¬Ø§Ù†Ø´ÛŒÙ†" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="md:col-span-2 relative">
                        <div class="flex justify-between items-center mb-2">
                            <label for="description" class="block font-medium text-gray-700">ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                            <button type="button" id="ai-rewrite-btn" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 flex items-center gap-1 transition-colors">
                                <span>âœï¸</span> Ù†Ú¯Ø§Ø±Ø´ Ø±Ø³Ù…ÛŒ
                            </button>
                        </div>
                        <textarea id="description" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                        <div id="rewrite-loading" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center text-indigo-600 font-bold rounded-lg">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ...</div>
                    </div>

                    <div class="md:col-span-2 flex flex-col sm:flex-row gap-3">
                        <button type="submit" id="submit-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow-lg">Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯</button>
                        <button type="button" id="cancel-edit-btn" class="flex-1 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition hidden">Ø§Ù†ØµØ±Ø§Ù</button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 md:mb-0">Ù„ÛŒØ³Øª Ø³ÙˆØ§Ø¨Ù‚</h2>
                    <div class="text-right text-sm font-semibold bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <p id="total-hours-display" class="text-gray-700">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</p>
                        <p id="grand-total-display" class="text-blue-800 text-base mt-1 border-t pt-1"></p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                    <div class="flex gap-2">
                        <button id="backup-btn" class="flex-1 bg-slate-700 text-white font-bold py-2 px-3 rounded-lg hover:bg-slate-800 text-xs flex justify-center items-center gap-1">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
                        <button id="restore-btn" class="flex-1 bg-slate-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-slate-700 text-xs flex justify-center items-center gap-1">â™»ï¸ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ</button>
                        <input type="file" id="restore-file" class="hidden" accept=".json">
                    </div>
                    <div class="flex gap-2">
                        <button id="export-btn" class="flex-1 bg-green-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-700 text-xs">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
                        <button id="import-btn" class="flex-1 bg-purple-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-purple-700 text-xs">ÙˆØ±ÙˆØ¯ Ø§Ú©Ø³Ù„</button>
                        <input type="file" id="import-file" class="hidden" accept=".xlsx, .xls, .csv">
                    </div>
                    <div class="flex gap-2">
                         <button id="ai-analyze-btn" class="flex-1 bg-indigo-100 text-indigo-700 font-bold py-2 px-3 rounded-lg hover:bg-indigo-200 text-xs border border-indigo-200 flex justify-center items-center gap-1">ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯</button>
                         <button id="delete-all-btn" class="w-auto bg-red-100 text-red-600 font-bold py-2 px-3 rounded-lg hover:bg-red-200 text-xs">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="w-full text-center">
                        <thead class="bg-gray-100 text-gray-600">
                            <tr>
                                <th class="p-3 text-sm font-bold whitespace-nowrap">ØªØ§Ø±ÛŒØ®</th>
                                <th class="p-3 text-sm font-bold whitespace-nowrap">Ø´ÛŒÙØª</th>
                                <th class="p-3 text-sm font-bold whitespace-nowrap">Ø¬Ø§Ù†Ø´ÛŒÙ†</th>
                                <th class="p-3 text-sm font-bold whitespace-nowrap min-w-[150px]">ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
                                <th class="p-3 text-sm font-bold whitespace-nowrap">Ø²Ù…Ø§Ù†</th>
                                <th class="p-3 text-sm font-bold whitespace-nowrap">Ù…Ø¯Øª</th>
                                <th class="p-3 text-sm font-bold whitespace-nowrap">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="overtime-records" class="divide-y divide-gray-100"></tbody>
                    </table>
                     <p id="no-records" class="text-center text-gray-400 py-8 hidden">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-12 text-gray-400 text-xs pb-8">
            <button id="change-settings-btn" class="text-blue-500 hover:underline mb-2">ØªØºÛŒÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡</button>
            <p>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ÛŒ ØªÙˆØ³Ø· <a href="https://wa.me/+989120929125" target="_blank" class="text-blue-600 hover:underline font-bold">Ø¬ÙˆØ§Ø¯ Ø§Ø¨Ø±Ø§Ù‡ÛŒÙ…ÛŒ</a></p>
            <p class="mt-1 opacity-50">Ù†Ø³Ø®Ù‡ 11.0.4</p>
        </footer>
    </div>

    <div id="settings-view" class="fixed inset-0 bg-gray-100 flex items-center justify-center p-4 z-50 hidden-view">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md border-t-8 border-blue-600 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <form id="settings-form">
                <div class="mb-4">
                    <label class="block mb-2 font-bold text-gray-700 text-sm">Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ú©Ø§Ø±ÛŒ</label>
                    <select id="complex-select" class="w-full p-3 border border-gray-300 rounded-lg form-select bg-gray-50">
                        <option value="alumina">Ø¢Ù„ÙˆÙ…ÛŒÙ†Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†</option>
                        <option value="shemsh">Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø´Ù…Ø´</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block mb-2 font-bold text-gray-700 text-sm">Ø§Ù„Ú¯ÙˆÛŒ Ø´ÛŒÙØª</label>
                    <select id="shift-pattern" class="w-full p-3 border border-gray-300 rounded-lg form-select bg-gray-50">
                        <option value="day_worker">Ø±ÙˆØ²Ú©Ø§Ø± (Ø´Ù†Ø¨Ù‡ ØªØ§ Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡)</option>
                        <option value="two_shift">Ø¯Ùˆ Ø´ÛŒÙØª (Ù‡ÙØªÙ‡ ØµØ¨Ø­ØŒ Ù‡ÙØªÙ‡ Ø¹ØµØ±)</option>
                        <option value="four_shift">Ú†Ù‡Ø§Ø± Ø´ÛŒÙØª (Û³ Ø¹ØµØ±ØŒ Û³ ØµØ¨Ø­ØŒ Û³ Ø´Ø¨ØŒ Û³ Ø§Ø³ØªØ±Ø§Ø­Øª)</option>
                        <option id="five-shift-option" value="five_shift" style="display: none;">Ù¾Ù†Ø¬ Ø´ÛŒÙØª (Û² Ø¹ØµØ±ØŒ Û² ØµØ¨Ø­ØŒ Û² Ø´Ø¨ØŒ Û´ Ø§Ø³ØªØ±Ø§Ø­Øª)</option>
                    </select>
                </div>

                <div id="calibration-wrapper" class="space-y-4 mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <p class="text-xs text-blue-800 font-bold mb-2">ØªÙ†Ø¸ÛŒÙ… ØªÙ‚ÙˆÛŒÙ… Ø´ÛŒÙØª:</p>
                    <div>
                        <label class="block mb-1 text-gray-700 text-xs">ÛŒÚ© ØªØ§Ø±ÛŒØ® Ù†Ù…ÙˆÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</label>
                        <input type="text" id="reference-date" placeholder="Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®" class="w-full p-2 border border-blue-200 rounded text-center bg-white text-sm" readonly>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block mb-1 text-gray-700 text-xs">Ù†ÙˆØ¹ Ø´ÛŒÙØª Ø¯Ø± Ø¢Ù† Ø±ÙˆØ²:</label>
                            <select id="reference-shift-type" class="w-full p-2 border border-blue-200 rounded text-sm">
                                <option value="evening">Ø¹ØµØ±</option>
                                <option value="morning">ØµØ¨Ø­</option>
                                <option value="night">Ø´Ø¨</option>
                                <option value="rest">Ø§Ø³ØªØ±Ø§Ø­Øª</option>
                            </select>
                        </div>
                        <div id="ref-day-wrapper">
                            <label class="block mb-1 text-gray-700 text-xs">Ú†Ù†Ø¯Ù…ÛŒÙ† Ø±ÙˆØ²ØŸ</label>
                            <input type="number" id="reference-shift-day" value="1" min="1" max="4" class="w-full p-2 border border-blue-200 rounded text-center text-sm">
                        </div>
                    </div>
                </div>

                <div class="mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block font-bold text-indigo-800 text-sm">Ú©Ù„ÛŒØ¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Gemini (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-600 hover:underline flex items-center gap-1">
                            <span>Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ÛŒØ¯ Ø±Ø§ÛŒÚ¯Ø§Ù†</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                        </a>
                    </div>
                    <input type="password" id="api-key-input" placeholder="API Key Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="w-full p-2 border border-indigo-200 rounded text-sm bg-white text-center dir-ltr">
                    <p class="text-xs text-indigo-600 mt-1">Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ØŒ Ú©Ù„ÛŒØ¯ API Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow-md">Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø´Ø±ÙˆØ¹</button>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-[101] hidden opacity-0 modal-backdrop backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-gray-800 mb-3" id="modal-title"></h3>
            <p class="text-gray-600 mb-6 text-sm leading-relaxed" id="modal-body"></p>
            <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-2">
                <button id="modal-cancel-btn" class="w-full sm:w-auto px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium">Ø§Ù†ØµØ±Ø§Ù</button>
                <button id="modal-confirm-btn" class="w-full sm:w-auto px-4 py-2 text-white rounded-lg text-sm font-medium shadow-md">ØªØ§ÛŒÛŒØ¯</button>
            </div>
        </div>
    </div>

    <div id="smart-fill-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-[102] hidden opacity-0 modal-backdrop backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all scale-100">
            <div class="p-5 border-b bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-t-xl">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <span>âœ¨</span> Ù¾Ø±Ú©Ø±Ø¯Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙØ±Ù…
                </h3>
            </div>
            <div class="p-6">
                <label class="block mb-3 text-gray-700 text-sm font-bold">Ù…ØªÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ ÛŒØ§ Ø¨Ú¯ÙˆÛŒÛŒØ¯:</label>
                <div class="relative">
                    <textarea id="smart-fill-input" rows="4" class="w-full p-4 border-2 border-indigo-100 rounded-xl focus:border-indigo-500 focus:ring-0 text-gray-800 text-sm pl-12" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¯ÛŒØ±ÙˆØ² Ø§Ø² Ø³Ø§Ø¹Øª Û´ Ø¹ØµØ± ØªØ§ Û¸ Ø´Ø¨ Ø¬Ø§ÛŒ Ø¢Ù‚Ø§ÛŒ Ø±Ø¶Ø§ÛŒÛŒ ÙˆØ§ÛŒØ³ØªØ§Ø¯Ù…..."></textarea>
                    <button id="mic-btn" class="absolute left-3 bottom-3 p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-red-100 hover:text-red-600 transition-all" title="Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø· ØµØ¯Ø§">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </button>
                </div>
                <div id="mic-status" class="hidden mt-2 text-xs text-red-600 font-bold flex items-center gap-1">
                    <span class="w-2 h-2 bg-red-600 rounded-full animate-pulse"></span> Ø¯Ø± Ø­Ø§Ù„ Ø´Ù†ÛŒØ¯Ù†...
                </div>
                <div id="smart-fill-loading" class="hidden mt-4 text-center text-indigo-600 font-bold animate-pulse text-sm">
                    Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù‡ÙˆØ´Ù…Ù†Ø¯...
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3">
                <button id="close-smart-fill" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm">Ø§Ù†ØµØ±Ø§Ù</button>
                <button id="process-smart-fill" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md text-sm">Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ Ø«Ø¨Øª</button>
            </div>
        </div>
    </div>

    <div id="analysis-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-[102] hidden opacity-0 modal-backdrop backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col transform transition-all scale-100">
            <div class="p-5 border-b bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-t-xl">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <span>ğŸ“Š</span> Ú¯Ø²Ø§Ø±Ø´ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯
                </h3>
            </div>
            <div id="analysis-content" class="p-6 overflow-y-auto prose prose-sm max-w-none text-right" dir="rtl">
                <div class="text-center py-10 text-gray-500">
                    <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p>Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø³ÙˆØ§Ø¨Ù‚ Ø´Ù…Ø§Ø³Øª...</p>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
                <button id="close-analysis" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md text-sm">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const getKey = () => {
            const settings = JSON.parse(localStorage.getItem('overtime_settings_v11_0_4'));
            return settings?.apiKey || "";
        };
        window.geminiSmartFill = async (text, todayJalali) => {
            const apiKey = getKey(); if (!apiKey) throw new Error("Ú©Ù„ÛŒØ¯ API ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: MODEL_NAME, generationConfig: { responseMimeType: "application/json" } });
            const prompt = `Extract fields from Persian input. Current Date: ${todayJalali}. JSON fields: date (YYYY/MM/DD), startTime (HH:MM format 24h), endTime (HH:MM format 24h), shiftType (morning/evening/night/rest/holiday/change_shift), successor, description. Input: "${text}"`;
            const result = await model.generateContent(prompt); return JSON.parse(result.response.text());
        };
        window.geminiRewrite = async (text) => {
            const apiKey = getKey(); if (!apiKey) throw new Error("Ú©Ù„ÛŒØ¯ API ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: MODEL_NAME });
            const result = await model.generateContent(`Rewrite formally in Persian: "${text}"`); return result.response.text();
        };
        window.geminiAnalyze = async (data) => {
            const apiKey = getKey(); if (!apiKey) throw new Error("Ú©Ù„ÛŒØ¯ API ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: MODEL_NAME });
            const prompt = `Analyze JSON overtime data for Iranian worker: ${JSON.stringify(data)}. Return concise Persian analysis with Markdown: Summary, Trend, Health Tip, Estimation.`;
            const result = await model.generateContent(prompt); return result.response.text();
        };
    </script>

    <script>
        window.addEventListener('load', () => {
            try {
                const getTehranMoment = (date, format) => moment.tz(date, format, "Asia/Tehran");
                const $ = id => document.getElementById(id);
                const appView = $('app-view');
                const settingsView = $('settings-view');
                
                const toEnglishDigits = (str) => {
                    if (!str) return str;
                    return str.replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)).replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d));
                };
                
                // Time to float converter: "14:30" -> 14.5
                const timeToFloat = (timeStr) => {
                    if (!timeStr) return 0;
                    const [h, m] = timeStr.split(':').map(Number);
                    return h + (m / 60);
                };
                
                // Float to Time string: 14.5 -> "14:30"
                // Not needed for input type=time as it uses string "HH:MM"

                // --- Data Migration (To v11.0.4) ---
                let overtimeData = JSON.parse(localStorage.getItem('overtime_data_v11_0_4')) || [];
                if (overtimeData.length === 0) {
                    const prevKeys = ['overtime_data_v11_0_3', 'overtime_data_v32', 'overtime_data_v28'];
                    for (let key of prevKeys) {
                        const oldData = JSON.parse(localStorage.getItem(key));
                        if (oldData && Array.isArray(oldData) && oldData.length > 0) {
                             // Migration: Convert old int hours to "HH:MM" strings if needed, but old code might just handle them poorly
                             // Simplest migration: assume old values were hours, append ":00"
                             const cleanData = oldData.filter(r => r.date).map(r => ({ 
                                 ...r, 
                                 id: r.id || (Date.now() + Math.random()), 
                                 // Ensure time is in HH:MM format for new input
                                 startTime: String(r.startTime).includes(':') ? r.startTime : `${String(r.startTime).padStart(2,'0')}:00`,
                                 endTime: String(r.endTime).includes(':') ? r.endTime : `${String(r.endTime).padStart(2,'0')}:00`
                             }));
                            overtimeData = cleanData;
                            break; 
                        }
                    }
                    localStorage.setItem('overtime_data_v11_0_4', JSON.stringify(overtimeData));
                }
                
                let userSettings = JSON.parse(localStorage.getItem('overtime_settings_v11_0_4')) || JSON.parse(localStorage.getItem('overtime_settings_v11_0_3')) || JSON.parse(localStorage.getItem('overtime_settings_v32')) || JSON.parse(localStorage.getItem('overtime_settings_v28'));
                let confirmCallback = null;
                let editingRecordId = null;

                const shiftTypeMap = { 'morning': 'Ø´ÛŒÙØª ØµØ¨Ø­', 'evening': 'Ø´ÛŒÙØª Ø¹ØµØ±', 'night': 'Ø´ÛŒÙØª Ø´Ø¨', 'rest': 'Ø§Ø³ØªØ±Ø§Ø­Øª', 'holiday': 'Ø±ÙˆØ² ØªØ¹Ø·ÛŒÙ„', 'change_shift': 'Ú†Ù†Ø¬ Ø´ÛŒÙØª' };
                const shiftPatterns = { four_shift: { cycleLength: 12, types: [{t: 'evening', d: 3}, {t: 'morning', d: 3}, {t: 'night', d: 3}, {t: 'rest', d: 3}] }, five_shift: { cycleLength: 10, types: [{t: 'evening', d: 2}, {t: 'morning', d: 2}, {t: 'night', d: 2}, {t: 'rest', d: 4}] } };

                const calculateShiftForDate = (targetDateStr) => {
                    if (!userSettings || !userSettings.shiftPattern) return null;
                    const pattern = userSettings.shiftPattern;
                    const cleanDateStr = toEnglishDigits(targetDateStr);
                    const targetDate = moment(cleanDateStr, 'jYYYY/jMM/DD').startOf('day');
                    if (!targetDate.isValid()) return null;

                    if (pattern === 'day_worker' || pattern === 'two_shift') {
                        const jDayOfWeek = targetDate.jDay(); 
                        const isWeekend = (jDayOfWeek === 5 || jDayOfWeek === 6);
                        if (isWeekend) return { type: 'rest', label: 'Ø¢Ø®Ø± Ù‡ÙØªÙ‡' };
                        if (pattern === 'day_worker') return { type: 'morning', label: 'Ø±ÙˆØ²Ú©Ø§Ø±' };
                        if(!userSettings.referenceDate) return null;
                        const refDate = moment(toEnglishDigits(userSettings.referenceDate), 'jYYYY/jMM/DD').startOf('day');
                        const weekDiff = targetDate.diff(refDate, 'weeks');
                        const refIsMorning = userSettings.referenceShiftType === 'morning';
                        return (weekDiff % 2 === 0) ? (refIsMorning ? { type: 'morning', label: 'Ù‡ÙØªÙ‡ ØµØ¨Ø­' } : { type: 'evening', label: 'Ù‡ÙØªÙ‡ Ø¹ØµØ±' }) : (refIsMorning ? { type: 'evening', label: 'Ù‡ÙØªÙ‡ Ø¹ØµØ±' } : { type: 'morning', label: 'Ù‡ÙØªÙ‡ ØµØ¨Ø­' });
                    }
                    if (!userSettings.referenceDate || !shiftPatterns[pattern]) return null;
                    const refDate = moment(toEnglishDigits(userSettings.referenceDate), 'jYYYY/jMM/DD').startOf('day');
                    const dayDiff = targetDate.diff(refDate, 'days');
                    const patternData = shiftPatterns[pattern];
                    let refDayIndex = 0; let acc = 0;
                    for(const s of patternData.types) { if(s.t === userSettings.referenceShiftType) { refDayIndex = acc + (userSettings.referenceShiftDay - 1); break; } acc += s.d; }
                    const targetDayIndex = (refDayIndex + dayDiff % patternData.cycleLength + patternData.cycleLength) % patternData.cycleLength;
                    acc = 0;
                    for(const s of patternData.types) { if (targetDayIndex < acc + s.d) { const dInS = targetDayIndex - acc + 1; const lMap = {'evening': 'Ø¹ØµØ±', 'morning': 'ØµØ¨Ø­', 'night': 'Ø´Ø¨', 'rest': 'Ø§Ø³ØªØ±Ø§Ø­Øª'}; return { type: s.t, label: `Ø±ÙˆØ² ${dInS} ${lMap[s.t]}` }; } acc += s.d; }
                    return null;
                };

                const saveData = () => localStorage.setItem('overtime_data_v11_0_4', JSON.stringify(overtimeData));
                const saveSettings = () => localStorage.setItem('overtime_settings_v11_0_4', JSON.stringify(userSettings));
                
                const calculateDuration = (s, e) => { 
                    // Inputs are "HH:MM"
                    const sVal = timeToFloat(s);
                    const eVal = timeToFloat(e);
                    let dur = (eVal > sVal) ? (eVal - sVal) : (24 - sVal + eVal);
                    // Return formatted to 2 decimals or fancy string
                    return dur.toFixed(2);
                };

                const showModal = (title, body, btnText, btnColor, onConfirm = null) => {
                    $('modal-title').textContent = title; $('modal-body').textContent = body;
                    const btn = $('modal-confirm-btn'); btn.textContent = btnText;
                    btn.className = `w-full sm:w-auto px-4 py-2 text-white rounded-lg ${btnColor} shadow-md`;
                    confirmCallback = onConfirm;
                    const m = $('confirm-modal'); m.classList.remove('hidden');
                    setTimeout(() => m.classList.remove('opacity-0'), 10);
                };
                const hideModal = () => { const m = $('confirm-modal'); m.classList.add('opacity-0'); setTimeout(() => { m.classList.add('hidden'); confirmCallback = null; }, 300); };

                const validateOvertime = (date, shiftType, startTime, endTime, currentId) => {
                    // Convert to floats for comparison
                    const sVal = timeToFloat(startTime);
                    const eVal = timeToFloat(endTime);

                    if (!['rest', 'holiday', 'change_shift'].includes(shiftType)) {
                        let forbidden = []; let errMsg = "";
                        const isShemsh = userSettings.complex === 'shemsh' && ['day_worker', 'two_shift'].includes(userSettings.shiftPattern);
                        if (isShemsh && ['morning', 'evening'].includes(shiftType)) { forbidden = [[7, 15]]; errMsg = "ØªØ¯Ø§Ø®Ù„ Ø¨Ø§ Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ Ø´Ù…Ø´"; } 
                        else if (shiftType === 'morning') { forbidden = [[7, 16]]; errMsg = "ØªØ¯Ø§Ø®Ù„ Ø¨Ø§ Ø´ÛŒÙØª ØµØ¨Ø­"; }
                        else if (shiftType === 'evening') { forbidden = [[15, 23.5]]; errMsg = "ØªØ¯Ø§Ø®Ù„ Ø¨Ø§ Ø´ÛŒÙØª Ø¹ØµØ±"; }
                        else if (shiftType === 'night') { forbidden = [[23, 24], [0, 7.5]]; errMsg = "ØªØ¯Ø§Ø®Ù„ Ø¨Ø§ Ø´ÛŒÙØª Ø´Ø¨"; }
                        
                        for(let f of forbidden) { 
                            // Simple overlap check: max(start1, start2) < min(end1, end2)
                            // This logic holds for standard shifts. Crossing midnight handled loosely.
                            if (Math.max(sVal, f[0]) < Math.min(eVal, f[1])) { 
                                showModal('Ø®Ø·Ø§ÛŒ Ø´ÛŒÙØª', errMsg, 'Ø¨Ø§Ø´Ù‡', 'bg-red-600'); return false; 
                            } 
                        }
                    }
                    
                    // Check against EXISTING records on same day
                    const sameDayRecords = overtimeData.filter(r => r.date === date && r.id !== currentId);
                    for(let rec of sameDayRecords) {
                        const oldS = timeToFloat(rec.startTime);
                        const oldE = timeToFloat(rec.endTime);
                        
                        // Overlap Logic: New Start < Old End AND New End > Old Start
                        // (Assuming standard non-midnight-crossing or simplistic view for single day)
                        if (sVal < oldE && eVal > oldS) {
                            showModal('ØªØ¯Ø§Ø®Ù„ Ø²Ù…Ø§Ù†ÛŒ', `Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø§ÛŒÙ† Ø±ÙˆØ² Ø³Ø§Ø¹Øª ${rec.startTime} ØªØ§ ${rec.endTime} Ø±Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.`, 'Ø§ØµÙ„Ø§Ø­ Ù…ÛŒâ€ŒÚ©Ù†Ù…', 'bg-orange-500');
                            return false;
                        }
                    }
                    return true;
                };

                const renderRecords = () => {
                    const tbody = $('overtime-records'); tbody.innerHTML = '';
                    let sorted = [];
                    try {
                        sorted = [...overtimeData].sort((a, b) => {
                            const da = a.date || ''; const db = b.date || '';
                            if (db !== da) return db.localeCompare(da);
                            return timeToFloat(a.startTime) - timeToFloat(b.startTime);
                        });
                    } catch (e) { sorted = overtimeData; }

                    if (sorted.length === 0) $('no-records').classList.remove('hidden');
                    else $('no-records').classList.add('hidden');

                    sorted.forEach(r => {
                        const tr = document.createElement('tr');
                        if(r.id === editingRecordId) tr.classList.add('editing-row');
                        tr.className += " hover:bg-gray-50 transition border-b border-gray-100";
                        tr.innerHTML = `
                            <td class="p-3 text-sm text-gray-700 whitespace-nowrap">${r.date || '-'}</td>
                            <td class="p-3 text-sm text-gray-600 whitespace-nowrap">${shiftTypeMap[r.shiftType] || ''}</td>
                            <td class="p-3 text-sm text-gray-500 whitespace-nowrap">${r.successor || '-'}</td>
                            <td class="p-3 text-sm text-gray-500 whitespace-nowrap min-w-[150px]" title="${r.description}">${r.description || '-'}</td>
                            <td class="p-3 text-sm font-mono text-blue-600 font-bold whitespace-nowrap" dir="ltr">${r.startTime} - ${r.endTime}</td>
                            <td class="p-3 text-sm font-bold text-gray-800 whitespace-nowrap">${calculateDuration(r.startTime, r.endTime)} Ø³Ø§Ø¹Øª</td>
                            <td class="p-3 text-sm whitespace-nowrap">
                                <button class="edit-btn text-blue-600 hover:text-blue-800 mx-1 font-medium" data-id="${r.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                                <span class="text-gray-300">|</span>
                                <button class="del-btn text-red-500 hover:text-red-700 mx-1 font-medium" data-id="${r.id}">Ø­Ø°Ù</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    const total = overtimeData.reduce((acc, r) => acc + parseFloat(calculateDuration(r.startTime, r.endTime)), 0);
                    let bonus = 0; if (userSettings && ['four_shift', 'five_shift'].includes(userSettings.shiftPattern) && overtimeData.some(r => ['morning', 'evening', 'night'].includes(r.shiftType))) bonus = 5;
                    $('total-hours-display').textContent = `Ù…Ø¬Ù…ÙˆØ¹: ${total.toFixed(2)} Ø³Ø§Ø¹Øª`;
                    $('grand-total-display').textContent = `Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø§ Ø§ÙˆØ±ØªØ§ÛŒÙ…: ${(total + bonus).toFixed(2)} Ø³Ø§Ø¹Øª`;
                };

                const resetForm = () => {
                    editingRecordId = null; $('editing-badge').classList.add('hidden'); $('overtime-form').reset();
                    $('submit-btn').textContent = 'Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯'; $('submit-btn').classList.remove('bg-yellow-500', 'hover:bg-yellow-600'); $('submit-btn').classList.add('bg-blue-600', 'hover:bg-blue-700'); $('cancel-edit-btn').classList.add('hidden');
                    
                    const today = moment().locale('fa').format('YYYY/MM/DD');
                    $('date-input').value = today;
                    updateShiftDisplay(today);
                };

                const updateShiftDisplay = (dateStr) => { 
                    const info = calculateShiftForDate(dateStr); 
                    if (info) { 
                        $('auto-shift-display').textContent = info.label; 
                        $('shift-type').value = info.type; 
                    } else $('auto-shift-display').textContent = ''; 
                };

                // --- Listeners ---
                const init = () => {
                    // No more populateTimeOptions needed
                    const setTodayForInput = (id) => { const el = $(id); if (el && !el.value) el.value = moment().locale('fa').format('YYYY/MM/DD'); };

                    $('change-settings-btn').addEventListener('click', () => { 
                        if(userSettings?.apiKey) $('api-key-input').value = userSettings.apiKey;
                        setTodayForInput('reference-date');
                        $('app-view').classList.add('hidden-view'); $('settings-view').classList.remove('hidden-view'); 
                    });
                    
                    $('settings-form').addEventListener('submit', (e) => { 
                        e.preventDefault(); 
                        const p = $('shift-pattern').value; 
                        if(p !== 'day_worker' && !$('reference-date').value) return alert('ØªØ§Ø±ÛŒØ® Ù…Ø±Ø¬Ø¹!'); 
                        
                        userSettings = { 
                            complex: $('complex-select').value, shiftPattern: p, 
                            referenceDate: $('reference-date').value, referenceShiftType: $('reference-shift-type').value, 
                            referenceShiftDay: parseInt($('reference-shift-day').value)||1, 
                            apiKey: $('api-key-input').value.trim() 
                        };
                        
                        saveSettings();
                        $('settings-view').classList.add('hidden-view');
                        $('app-view').classList.remove('hidden-view');
                        resetForm();
                    });
                    
                    const updateSets = () => { 
                        const p = $('shift-pattern').value; 
                        if(p === 'day_worker') $('calibration-wrapper').classList.add('hidden'); 
                        else { 
                            $('calibration-wrapper').classList.remove('hidden'); 
                            if(p === 'two_shift') { $('reference-shift-type').innerHTML = '<option value="morning">Ù‡ÙØªÙ‡ ØµØ¨Ø­</option><option value="evening">Ù‡ÙØªÙ‡ Ø¹ØµØ±</option>'; $('ref-day-wrapper').classList.add('hidden'); } 
                            else { $('reference-shift-type').innerHTML = '<option value="evening">Ø¹ØµØ±</option><option value="morning">ØµØ¨Ø­</option><option value="night">Ø´Ø¨</option><option value="rest">Ø§Ø³ØªØ±Ø§Ø­Øª</option>'; $('ref-day-wrapper').classList.remove('hidden'); } 
                        } 
                    };
                    $('shift-pattern').addEventListener('change', updateSets); 
                    
                    $('complex-select').addEventListener('change', () => { 
                        const isShemsh = $('complex-select').value === 'shemsh';
                        $('five-shift-option').style.display = isShemsh ? 'block' : 'none';
                        if(!isShemsh && $('shift-pattern').value === 'five_shift') { $('shift-pattern').value = 'four_shift'; updateSets(); }
                    });
                    
                    const handleDateSelect = (d, elementId) => { setTimeout(() => { const val = document.getElementById(elementId).value; if(elementId === 'date-input' && val) updateShiftDisplay(val); }, 100); };
                    kamaDatepicker('date-input', { twodigit: true, closeAfterSelect: true, gotoToday: true, onselect: (d) => handleDateSelect(d, 'date-input') });
                    kamaDatepicker('reference-date', { twodigit: true, closeAfterSelect: true, gotoToday: true });

                    resetForm(); renderRecords(); updateSets();
                    
                    if($('complex-select').value === 'shemsh') $('five-shift-option').style.display='block';
                    setTodayForInput('reference-date');
                };

                if(!userSettings) {
                    settingsView.classList.remove('hidden-view'); 
                    setTimeout(() => {
                         const el = document.getElementById('reference-date');
                         if(el) el.value = moment().locale('fa').format('YYYY/MM/DD');
                    }, 500);
                } else { appView.classList.remove('hidden-view'); }
                
                init();

                // Handlers
                $('overtime-form').addEventListener('submit', (e) => {
                    e.preventDefault(); 
                    const date = $('date-input').value; if (!date) return showModal('Ø®Ø·Ø§', 'ØªØ§Ø±ÛŒØ®!', 'Ø¨Ø§Ø´Ù‡', 'bg-red-500');
                    // Use input[type=time] values
                    const sTime = $('start-time').value;
                    const eTime = $('end-time').value;
                    
                    if (!sTime || !eTime) return showModal('Ø®Ø·Ø§', 'Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'Ø¨Ø§Ø´Ù‡', 'bg-red-500');
                    
                    const sType = $('shift-type').value;

                    if (!validateOvertime(date, sType, sTime, eTime, editingRecordId)) return;

                    const record = { 
                        id: editingRecordId || (Date.now() + Math.random()),
                        date, shiftType: sType, startTime: sTime, endTime: eTime, 
                        successor: $('successor-input').value.trim(), description: $('description').value.trim() 
                    };
                    
                    if (editingRecordId) {
                        const idx = overtimeData.findIndex(r => r.id == editingRecordId);
                        if(idx > -1) overtimeData[idx] = record;
                    } else {
                        overtimeData.push(record);
                    }
                    saveData();
                    resetForm();
                    renderRecords();
                });

                $('cancel-edit-btn').addEventListener('click', resetForm);
                
                $('overtime-records').addEventListener('click', (e) => {
                    const btn = e.target.closest('button'); if (!btn) return; 
                    const id = btn.dataset.id;
                    if (btn.classList.contains('del-btn')) {
                        showModal('Ø­Ø°Ù', 'Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ', 'Ø¨Ù„Ù‡', 'bg-red-600', () => { 
                            overtimeData = overtimeData.filter(r => r.id != id);
                            if(editingRecordId == id) resetForm();
                            saveData();
                            renderRecords();
                            hideModal(); 
                        });
                    }
                    if (btn.classList.contains('edit-btn')) {
                        const rec = overtimeData.find(r => r.id == id); if (!rec) return;
                        editingRecordId = id; 
                        $('editing-badge').classList.remove('hidden'); 
                        $('date-input').value = rec.date; $('shift-type').value = rec.shiftType; 
                        $('start-time').value = rec.startTime; $('end-time').value = rec.endTime; 
                        $('successor-input').value = rec.successor; $('description').value = rec.description; 
                        updateShiftDisplay(rec.date);
                        $('submit-btn').textContent = 'Ø°Ø®ÛŒØ±Ù‡'; $('submit-btn').classList.replace('bg-blue-600', 'bg-yellow-500'); 
                        $('cancel-edit-btn').classList.remove('hidden'); 
                        renderRecords(); window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });

                $('modal-cancel-btn').addEventListener('click', hideModal); 
                $('modal-confirm-btn').addEventListener('click', () => { if(confirmCallback) confirmCallback(); else hideModal(); });
                $('delete-all-btn').addEventListener('click', () => showModal('Ø­Ø°Ù Ù‡Ù…Ù‡', 'Ù‡Ù…Ù‡ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ', 'Ø¨Ù„Ù‡', 'bg-red-600', () => { 
                    overtimeData = [];
                    saveData();
                    renderRecords();
                    hideModal(); 
                }));

                // Backup Logic
                $('backup-btn').addEventListener('click', () => {
                    const data = { settings: userSettings, records: overtimeData, version: '11.0.4' };
                    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `Overtime_Backup_${moment().format('YYYYMMDD')}.json`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                });
                $('restore-btn').addEventListener('click', () => $('restore-file').click());
                $('restore-file').addEventListener('change', (e) => {
                    const f = e.target.files[0]; if(!f) return;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        try {
                            const backup = JSON.parse(ev.target.result);
                            if(backup.settings && backup.records) {
                                userSettings = backup.settings; overtimeData = backup.records;
                                saveData(); saveSettings(); renderRecords(); alert('Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. ØµÙØ­Ù‡ Ø±ÙØ±Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯.'); location.reload();
                            } else alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                        } catch(err) { alert('Ø®Ø·Ø§ Ø¯Ø± ÙØ§ÛŒÙ„'); }
                    }; r.readAsText(f); e.target.value = '';
                });

                // Export Logic
                $('export-btn').addEventListener('click', () => {
                    if (!overtimeData.length) return alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³Øª');
                    const exportData = overtimeData.map(r => ({
                        'ØªØ§Ø±ÛŒØ®': r.date,
                        'Ù†ÙˆØ¹ Ø´ÛŒÙØª': shiftTypeMap[r.shiftType] || r.shiftType,
                        'Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹': r.startTime,
                        'Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù†': r.endTime,
                        'Ø¬Ø§Ù†Ø´ÛŒÙ†': r.successor,
                        'ØªÙˆØ¶ÛŒØ­Ø§Øª': r.description
                    }));
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Overtime");
                    XLSX.writeFile(wb, "Overtime.xlsx");
                });

                // Import Logic
                $('import-btn').addEventListener('click', () => $('import-file').click());
                $('import-file').addEventListener('change', (e) => {
                    const f = e.target.files[0]; if(!f) return;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        try {
                            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            if(json.length) {
                                json.forEach(row => {
                                    const dateVal = row['ØªØ§Ø±ÛŒØ®'] || row['date'];
                                    if(dateVal) {
                                        const shiftName = row['Ù†ÙˆØ¹ Ø´ÛŒÙØª'] || row['shiftType'];
                                        const shiftKey = Object.keys(shiftTypeMap).find(k => shiftTypeMap[k] === shiftName) || 'morning';
                                        // Ensure imported times are formatted
                                        let sImport = row['Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹'] || row['startTime'] || "07:00";
                                        let eImport = row['Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù†'] || row['endTime'] || "16:00";
                                        // Simple check if it's a decimal from old Excel
                                        if(!String(sImport).includes(':')) sImport = `${String(sImport).padStart(2,'0')}:00`;
                                        if(!String(eImport).includes(':')) eImport = `${String(eImport).padStart(2,'0')}:00`;

                                        overtimeData.push({ id: Date.now() + Math.random(), date: dateVal, shiftType: shiftKey, startTime: sImport, endTime: eImport, successor: row['Ø¬Ø§Ù†Ø´ÛŒÙ†'] || row['successor'] || '', description: row['ØªÙˆØ¶ÛŒØ­Ø§Øª'] || row['description'] || '' });
                                    }
                                });
                                saveData(); renderRecords(); alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯');
                            }
                        } catch(err) { alert('Ø®Ø·Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„'); }
                    }; r.readAsArrayBuffer(f); e.target.value = '';
                });

                // AI Buttons Logic
                $('open-smart-fill').addEventListener('click', () => { $('smart-fill-modal').classList.remove('hidden'); setTimeout(() => $('smart-fill-modal').classList.remove('opacity-0'), 10); });
                $('close-smart-fill').addEventListener('click', () => { $('smart-fill-modal').classList.add('opacity-0'); setTimeout(() => $('smart-fill-modal').classList.add('hidden'), 300); });
                $('process-smart-fill').addEventListener('click', async () => {
                    const text = $('smart-fill-input').value; if(!text) return alert('Ù…ØªÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                    $('smart-fill-loading').classList.remove('hidden');
                    try {
                        const today = moment().locale('fa').format('YYYY/MM/DD');
                        const result = await window.geminiSmartFill(text, today);
                        if(result.date) { $('date-input').value = result.date; updateShiftDisplay(result.date); }
                        if(result.startTime) $('start-time').value = result.startTime; if(result.endTime) $('end-time').value = result.endTime;
                        if(result.shiftType) $('shift-type').value = result.shiftType; if(result.successor) $('successor-input').value = result.successor;
                        if(result.description) $('description').value = result.description;
                        $('close-smart-fill').click(); $('smart-fill-input').value = ''; showModal('Ù…ÙˆÙÙ‚', 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø± Ø´Ø¯.', 'Ø¨Ø§Ø´Ù‡', 'bg-green-600');
                    } catch(err) { alert('Ø®Ø·Ø§: ' + err.message); } finally { $('smart-fill-loading').classList.add('hidden'); }
                });
                $('ai-rewrite-btn').addEventListener('click', async () => {
                    const txt = $('description').value; if(!txt) return alert('Ù…ØªÙ† Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                    $('rewrite-loading').classList.remove('hidden');
                    try { const formal = await window.geminiRewrite(txt); $('description').value = formal.trim(); } catch(err) { alert(err.message); } finally { $('rewrite-loading').classList.add('hidden'); }
                });
                $('ai-analyze-btn').addEventListener('click', async () => {
                    if(overtimeData.length === 0) return alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³Øª');
                    $('analysis-modal').classList.remove('hidden'); setTimeout(() => $('analysis-modal').classList.remove('opacity-0'), 10);
                    try {
                        const reportMd = await window.geminiAnalyze(overtimeData);
                        const html = reportMd.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/^\* (.*$)/gm, '<li>$1</li>').replace(/\n/g, '<br>');
                        $('analysis-content').innerHTML = html;
                    } catch(err) { $('analysis-content').innerHTML = `<p class="text-red-500">Ø®Ø·Ø§: ${err.message}</p>`; }
                });
                $('close-analysis').addEventListener('click', () => { $('analysis-modal').classList.add('opacity-0'); setTimeout(() => $('analysis-modal').classList.add('hidden'), 300); });

            } catch(e) { console.error(e); alert('Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ'); }
        });
    </script>
</body>
</html>
